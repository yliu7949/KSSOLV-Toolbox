<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collapsible Tree Table</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .table-container {
      display: flex;
      justify-content: center;
    }
    table {
      border-collapse: collapse;
      width: 100%; /* 宽度为100%，以便于响应式变化 */
      border-radius: 2px;
      overflow: hidden;
      font-size: 13px;
      color: #565656;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 4px;
      text-align: left;
      white-space: nowrap; /* Prevent text wrapping */
      overflow: hidden; /* Hide text that overflows */
      text-overflow: ellipsis; /* Optional: add ellipsis for overflowed text */
    }
    th {
      background-color: #eeeeee;
      user-select: none; /* 禁止选择文字 */
      position: relative;
    }
    tr {
      user-select: none;
      background-color: white;
    }
    tr.hidden {
      display: none;
    }
    .selected {
      background-color: #e2f1fb; /* 被选中行的背景色 */
    }
    .selected td {
      background-color: #e2f1fb; /* 被选中单元格的更深背景色 */
    }
    .folder-icon {
      background-image: url('assets/folder.svg');
    }
    .workflow-icon {
      background-image: url("assets/workflow.svg");
    }
    .file-icon {
      background-image: url("assets/file.svg");
    }
    .toggle-icon {
      cursor: pointer;
    }
    .resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 3px; /* width of the draggable area */
      height: 100%;
      cursor: col-resize;
      background-color: transparent; /* or a color for visibility */
    }
    .icon-container {
      display: inline-block;
      width: 16px; /* Adjust the width as necessary */
      height: 16px; /* Adjust the height as necessary */
      vertical-align: middle; /* To align with the text */
      background-size: contain; /* 或者使用 cover，根据需要调整 */
      background-position: center; /* 使背景图像居中 */
      background-repeat: no-repeat; /* 防止背景图像重复 */
    }
    .icon-container:hover {
      opacity: 0.7;
    }
  </style>
  <script>
    // JSON data for test purpose
    let tableData = `
      {
        "name": "Project(3510f463-8122-4afc-8716-c64363395bfc)",
        "label": "Project",
        "description": "",
        "type": "Project",
        "children": [
          {
            "name": "Workflow(6d7fb652-d63b-41cd-9f1d-b37d0a68a100)",
            "label": "Workflow",
            "description": "",
            "type": "Workflow",
            "children": [
              {
                "name": "Workflow1(35c9b62d-0792-446b-8646-bb6d8fb2ae11)",
                "label": "Workflow1",
                "description": "",
                "type": "Workflow",
                "children": [],
                "childrenCount": "0x0"
              },
              {
                "name": "Workflow2(2af93a99-d2f0-4fc2-88bd-2f3fd6499d5e)",
                "label": "Workflow2",
                "description": "",
                "type": "Workflow",
                "children": [],
                "childrenCount": "0x0"
              }
            ],
            "childrenCount": "2x1"
          },
          {
            "name": "Structure(410104e7-744d-44fb-aac6-8ea5363e555a)",
            "label": "Structure",
            "description": "",
            "type": "Structure",
            "children": [
              {
                "name": "Structure1(26876c86-2375-4887-b8b7-f63543149d2f)",
                "label": "Structure1",
                "description": "",
                "type": "Structure",
                "children": [],
                "childrenCount": "0x0"
              },
              {
                "name": "Structure2(cdf4938a-3639-49e9-968c-6647be8120b7)",
                "label": "Structure2",
                "description": "",
                "type": "Structure",
                "children": [],
                "childrenCount": "0x0"
              }
            ],
            "childrenCount": "2x1"
          }
        ],
        "childrenCount": "2x1"
      }`
    let MATLAB;

    // 找到给定节点的所有直接和递归子节点
    function findAllChildNodes(treeData, nodeName) {
      let allChildren = [];

      // 递归搜索子节点的辅助函数
      function searchChildren(node, isParentNode) {
        if (node.name === nodeName || isParentNode) {
          if (node.children) {
            node.children.forEach(child => {
              allChildren.push(child.name);
              searchChildren(child, true);
            });
          }
        } else if (node.children) {
          node.children.forEach(child => searchChildren(child, false));
        }
      }

      // 从树的根节点开始递归搜索
      searchChildren(treeData[0], false);

      return allChildren;
    }

    // 根据指定行的点击事件切换子节点的显示状态
    function toggleChildren(event) {
      const parentRowElement = event.target.parentElement.parentElement;
      const parentName = parentRowElement.getAttribute('data-name');
      const parentLevel = parentRowElement.getAttribute('data-level');

      // 获取所有直接和递归子节点名称
      const allChildren = findAllChildNodes(tableData, parentName);

      // 获取所有表格行
      const allRows = document.querySelectorAll('tr[data-name]');

      // 切换父节点的显示状态
      const isCurrentlyExpanded = parentRowElement.classList.contains('expanded');

      // 更新父节点的状态
      if (isCurrentlyExpanded) {
        parentRowElement.classList.remove('expanded');
      } else {
        parentRowElement.classList.add('expanded');
      }

      // 检查是否应该将 expanded 类添加到所有子节点
      const shouldExpandChildren = !isCurrentlyExpanded && parentLevel === '0';

      // 遍历所有子节点并设置显示或隐藏状态
      allChildren.forEach(childName => {
        const row = [...allRows].find(row => row.getAttribute('data-name') === childName);
        if (row) {
          const shouldHide = isCurrentlyExpanded; // 如果当前已经展开，则折叠，否则展开
          row.classList.toggle('hidden', shouldHide);
          row.style.display = shouldHide ? 'none' : '';

          // 如果父节点级别为 0 且要展开子节点，将 expanded 类添加到每个子节点
          if (shouldExpandChildren) {
            row.classList.add('expanded');
          }
        }
      });
    }

    // Function to toggle row selection
    function toggleRowSelection(event) {
      const allRows = document.querySelectorAll('tr');
      allRows.forEach(row => {
        row.classList.remove('selected'); // Remove the 'selected' class
      });

      const rowElement = event.target.closest('tr');
      rowElement.classList.add('selected'); // Add the 'selected' class to the clicked row
    }

    // Function to create the table rows
    function createRow(data, level, parentId) {
      const row = document.createElement('tr');
      row.setAttribute('data-level', level);
      row.setAttribute('data-name', data.name);
      row.setAttribute('data-parent', parentId);
      row.addEventListener('click', function (event) {
        toggleRowSelection(event);
        const rowElement = event.target.closest('tr');
        MATLAB.sendEventToMATLAB("RowClicked", rowElement.getAttribute('data-name'));
      });
      row.addEventListener('dblclick', function (event) {
        toggleRowSelection(event);
        const rowElement = event.target.closest('tr');
        MATLAB.sendEventToMATLAB("RowDoubleClicked", rowElement.getAttribute('data-name'));
      });
      row.addEventListener('contextmenu', function (event) {
        // 阻止默认的上下文菜单显示
        event.preventDefault();

        // 执行toggleRowSelection函数
        toggleRowSelection(event);
      });

      const nameCell = document.createElement('td');
      nameCell.style.paddingLeft = `${20 * level + 10}px`;

      if (data.children && data.children.length > 0) {
        // Create a container for the SVG to enable CSS styling and events
        const folderIconContainer = document.createElement('div');
        folderIconContainer.className = 'icon-container toggle-icon folder-icon';
        folderIconContainer.setAttribute('data-target', data.name);
        folderIconContainer.onclick = toggleChildren;

        nameCell.appendChild(folderIconContainer);
      } else {
        const fileIconContainer = document.createElement('div');
        fileIconContainer.className = 'icon-container file-icon';

        nameCell.appendChild(fileIconContainer);
      }

      nameCell.append(` ${data.label}`);
      row.classList.add('expanded');
      row.appendChild(nameCell);

      const sizeCell = document.createElement('td');
      sizeCell.innerText = data.childrenCount || ''; // Added fallback for 'size' property
      row.appendChild(sizeCell);

      const typeCell = document.createElement('td');
      typeCell.innerText = data.type;
      row.appendChild(typeCell);

      return row;
    }

    // Function to build the table
    function buildTable(data, table, level = 0, parentId = '') {
      data.forEach(item => {
        const row = createRow(item, level, parentId);
        table.appendChild(row);

        if (item.children && item.children.length > 0) {
          buildTable(item.children, table, level + 1, item.name);
        }
      });
    }

    // Function to resizable columns
    function addResizableColumns() {
      const thElements = document.querySelectorAll('th');
      thElements.forEach((th, index) => {
        // 显式地设定 width 属性，避免折叠行时，列的宽度会发生变化
        th.style.width = window.getComputedStyle(th).width;

        // Skip the last header cell
        if (index === (thElements.length - 1)) return;

        const resizeHandle = document.createElement('div');
        resizeHandle.classList.add('resize-handle');

        // 获取右侧相邻的 th 元素
        const nextTh = th.nextElementSibling;
        const totalWidth = th.offsetWidth + nextTh.offsetWidth;

        resizeHandle.addEventListener('mousedown', e => {
          let start = e.pageX;
          let initialThWidth = parseFloat(window.getComputedStyle(th).width);
          let initialNextThWidth = parseFloat(window.getComputedStyle(nextTh).width);

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);

          function onMouseMove(e) {
            const diff = e.pageX - start;
            if (diff < 0) {
              const newThWidth = diff + initialThWidth;
              if (newThWidth > 0) {
                nextTh.style.width = '';
                th.style.width = newThWidth + 'px';
              }
            } else {
              const newNextThWidth = initialNextThWidth - diff;
              if (newNextThWidth > 0) {
                th.style.width = '';
                nextTh.style.width = newNextThWidth + 'px';
              }
            }
          }

          function onMouseUp() {
            thElements.forEach((th) => {
              // 显式地设定 width 属性，避免折叠行时，列的宽度会发生变化
              th.style.width = window.getComputedStyle(th).width;
            });
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }
        });

        th.appendChild(resizeHandle);
      });
    }

    // Building the table on window load
    /*
    window.onload = function() {
      const table = document.getElementById('tree-table');
      tableData = [JSON.parse(tableData)];
      buildTable(tableData, table.children[1]);
      addResizableColumns();
    };
    */

    // MATLAB execute this setup function
    function setup(htmlComponent) {
      MATLAB = htmlComponent;
      htmlComponent.addEventListener("DataChanged", dataFromMATLABToHTML);

      function dataFromMATLABToHTML(event) {
        const table = document.getElementById('tree-table');
        let text = htmlComponent.Data;
        tableData = [JSON.parse(text)];
        buildTable(tableData, table.children[1]);
        addResizableColumns();
      }
    }
  </script>
</head>
<body>

<div class="table-container">
  <table id="tree-table">
    <thead>
    <tr>
      <th>Name</th>
      <th>Size</th>
      <th>Type</th>
    </tr>
    </thead>
    <tbody>
    <!-- Table rows will be inserted here dynamically -->
    </tbody>
  </table>
</div>

</body>
</html>
