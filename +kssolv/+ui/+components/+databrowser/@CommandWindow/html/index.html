<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Window UI</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: Arial, sans-serif;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 5px;
        }

        #terminal {
            flex-grow: 1;
            width: 100%;
            border: transparent;
            background: white;
            overflow-y: auto;
            padding: 5px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }

        #input-container {
            display: flex;
            align-items: center;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            position: sticky;
            bottom: 0;
            background: white;
        }

        #input-container span {
            margin-right: 7px;
            font-family: monospace;
            font-size: 15px;
        }

        #command-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 5px;
            font-size: 15px;
            font-family: monospace;
            height: 30px;
        }

        #suggestions-container {
            position: absolute;
            bottom: 100%;
            left: 30px;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            margin-bottom: 10px;
            scrollbar-width: thin;
        }

        #suggestions-container::-webkit-scrollbar {
            width: 8px;
        }

        #suggestions-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #suggestions-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #suggestions-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
            font-family: monospace;
            font-size: 13px;
            height: 30px;
            line-height: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .suggestion-item.selected {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
<div id="terminal"></div>

<div id="input-container">
    <span>&gt;&gt;</span>
    <label for="command-input"></label>
    <input autofocus id="command-input" type="text">
    <div id="suggestions-container"></div>
</div>

<script>
    // 基础变量声明
    let MATLAB;                          // MATLAB组件引用
    let history = [];                    // 命令历史记录
    let historyIndex = -1;               // 历史记录当前索引
    let selectedSuggestionIndex = -1;    // 当前选中的建议项索引
    let references = ['clc', 'whos', 'help', 'dev', 'clear', 'ANS']; // 基础命令列表

    const terminal = document.getElementById("terminal");
    const input = document.getElementById("command-input");
    const suggestionsContainer = document.getElementById("suggestions-container");

    // 查找数组中所有字符串的最长公共前缀
    function findLongestCommonPrefix(strings, currentInput) {
        if (strings.length === 0) return '';

        // 获取当前输入后的相关部分
        const relevantParts = strings.map(str => str.slice(currentInput.length));

        // 从第一个字符串开始作为潜在前缀
        let prefix = relevantParts[0];

        // 与其他字符串比较
        for (let i = 1; i < relevantParts.length; i++) {
            // 当前前缀与当前字符串不匹配时
            while (relevantParts[i].indexOf(prefix) !== 0) {
                // 缩短前缀
                prefix = prefix.substring(0, prefix.length - 1);
                if (prefix === '') return '';
            }
        }

        return prefix;
    }

    // 获取待补全的文本
    function getLastWord(value, cursorPosition) {
        const textBeforeCursor = value.substring(0, cursorPosition);
        const match = textBeforeCursor.match(/([a-zA-Z]+\.)*[a-zA-Z.]*$/);
        return match ? match[0] : '';
    }

    // 获取匹配的建议列表
    function getSuggestions(input) {
        if (!input) return [];
        return references.filter(ref =>
            ref.toLowerCase().startsWith(input.toLowerCase())
        );
    }

    // 插入补全文本
    function insertCompletion(originalText, cursorPosition, completion, lastWord) {
        const beforeCursor = originalText.substring(0, cursorPosition - lastWord.length);
        const afterCursor = originalText.substring(cursorPosition);
        return beforeCursor + completion + afterCursor;
    }

    // 应用选中的建议
    function applySelectedSuggestion() {
        const suggestionItems = suggestionsContainer.querySelectorAll('.suggestion-item');
        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
            const suggestion = suggestionItems[selectedSuggestionIndex].textContent;
            const cursorPosition = input.selectionStart;
            const lastWord = getLastWord(input.value, cursorPosition);
            input.value = insertCompletion(input.value, cursorPosition, suggestion, lastWord);
            suggestionsContainer.style.display = 'none';
            input.focus();
            const newPosition = cursorPosition - lastWord.length + suggestion.length;
            input.setSelectionRange(newPosition, newPosition);
            selectedSuggestionIndex = -1;
        }
    }

    // 更新选中的建议项
    function updateSelectedSuggestion() {
        const items = suggestionsContainer.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            if (index === selectedSuggestionIndex) {
                item.classList.add('selected');
                // 确保选中项可见
                const containerHeight = suggestionsContainer.clientHeight;
                const itemHeight = item.offsetHeight;
                const itemTop = item.offsetTop;
                const scrollTop = suggestionsContainer.scrollTop;

                if (itemTop < scrollTop) {
                    suggestionsContainer.scrollTop = itemTop;
                } else if (itemTop + itemHeight > scrollTop + containerHeight) {
                    suggestionsContainer.scrollTop = itemTop + itemHeight - containerHeight;
                }
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // 显示建议列表
    function showSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.onclick = () => {
                const cursorPosition = input.selectionStart;
                const lastWord = getLastWord(input.value, cursorPosition);
                input.value = insertCompletion(input.value, cursorPosition, suggestion, lastWord);
                suggestionsContainer.style.display = 'none';
                input.focus();
                const newPosition = cursorPosition - lastWord.length + suggestion.length;
                input.setSelectionRange(newPosition, newPosition);
                selectedSuggestionIndex = -1;
            };
            suggestionsContainer.appendChild(div);
        });
        suggestionsContainer.style.display = suggestions.length ? 'block' : 'none';
        selectedSuggestionIndex = -1;
    }

    // 处理滚轮事件
    suggestionsContainer.addEventListener('wheel', function (e) {
        e.preventDefault();
        suggestionsContainer.scrollTop += e.deltaY;
    });

    // 处理键盘事件
    input.addEventListener("keydown", function (event) {
        const isSuggestionsVisible = suggestionsContainer.style.display === 'block';

        if (event.key === "Tab") {
            event.preventDefault();

            if (isSuggestionsVisible) {
                if (selectedSuggestionIndex >= 0) {
                    applySelectedSuggestion();
                } else {
                    const cursorPosition = input.selectionStart;
                    const lastWord = getLastWord(input.value, cursorPosition);
                    const matches = getSuggestions(lastWord);

                    if (matches.length > 1) {
                        // 找到最长公共前缀并应用
                        const commonPrefix = findLongestCommonPrefix(matches, lastWord);
                        if (commonPrefix) {
                            const newValue = lastWord + commonPrefix;
                            input.value = insertCompletion(input.value, cursorPosition, newValue, lastWord);
                            const newPosition = cursorPosition - lastWord.length + newValue.length;
                            input.setSelectionRange(newPosition, newPosition);

                            // 更新建议列表
                            const newMatches = getSuggestions(newValue);
                            showSuggestions(newMatches);
                        }
                    } else if (matches.length === 1) {
                        input.value = insertCompletion(input.value, cursorPosition, matches[0], lastWord);
                        suggestionsContainer.style.display = 'none';
                        const newPosition = cursorPosition - lastWord.length + matches[0].length;
                        input.setSelectionRange(newPosition, newPosition);
                    }
                }
            } else {
                const cursorPosition = input.selectionStart;
                const lastWord = getLastWord(input.value, cursorPosition);
                const matches = getSuggestions(lastWord);

                if (matches.length === 1) {
                    input.value = insertCompletion(input.value, cursorPosition, matches[0], lastWord);
                    const newPosition = cursorPosition - lastWord.length + matches[0].length;
                    input.setSelectionRange(newPosition, newPosition);
                } else if (matches.length > 1) {
                    showSuggestions(matches);
                }
            }
        } else if (event.key === "Enter") {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
            let command = input.value.trim();

            if (command) {
                history.push(command);
                historyIndex = history.length;

                if (/\bclear\b/i.test(command)) {
                    input.value = "";
                    terminal.innerHTML += `>> ${command}\n`;
                    return;
                } else if (/\bclc\b/i.test(command)) {
                    terminal.innerHTML = "";
                    input.value = "";
                    return;
                }

                terminal.innerHTML += `>> ${command}\n`;
                if (command === "dev") {
                    command = "kssolv.ui.debug.WebWindow.openDevTools()";
                }
                sendCommandToMATLAB(command);
            }
            input.value = "";
        } else if (event.key === "Escape") {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
        } else if (event.key === "ArrowUp") {
            if (isSuggestionsVisible) {
                event.preventDefault();
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                if (selectedSuggestionIndex > 0) {
                    selectedSuggestionIndex--;
                } else {
                    selectedSuggestionIndex = items.length - 1;
                }
                updateSelectedSuggestion();
            } else if (historyIndex > 0) {
                historyIndex--;
                input.value = history[historyIndex];
            }
            event.preventDefault();
        } else if (event.key === "ArrowDown") {
            if (isSuggestionsVisible) {
                event.preventDefault();
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                if (selectedSuggestionIndex < items.length - 1) {
                    selectedSuggestionIndex++;
                } else {
                    selectedSuggestionIndex = 0;
                }
                updateSelectedSuggestion();
            } else {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    input.value = history[historyIndex];
                } else {
                    historyIndex = history.length;
                    input.value = "";
                }
            }
            event.preventDefault();
        }
    });

    // 输入时更新建议列表
    input.addEventListener("input", function () {
        const cursorPosition = input.selectionStart;
        const lastWord = getLastWord(input.value, cursorPosition);
        const matches = getSuggestions(lastWord);
        showSuggestions(matches);
    });

    // 点击其他区域时隐藏建议列表
    document.addEventListener('click', function (e) {
        if (!suggestionsContainer.contains(e.target) && e.target !== input) {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
    });

    // 发送命令到MATLAB
    function sendCommandToMATLAB(command) {
        if (typeof MATLAB !== 'undefined') {
            MATLAB.sendEventToMATLAB("CommandSubmitted", command);
        } else {
            terminal.innerHTML += "!! MATLAB 不可用\n\n";
        }
    }

    // 设置MATLAB组件
    function setup(htmlComponent) {
        MATLAB = htmlComponent;
        htmlComponent.addEventListener("ResultUpdated", resultFromMATLABToHTML);
        htmlComponent.addEventListener("DataChanged", () => {
            references = MATLAB.Data.join(',');
            references = references.split(',');
            references = ['ANS', 'dev'].concat(references);
        });
    }

    // 处理MATLAB返回结果
    function resultFromMATLABToHTML(event) {
        if (event.Data) {
            terminal.innerHTML += event.Data + "\n";

            document.querySelectorAll('#terminal a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    let command = this.getAttribute('href');
                    if (command.startsWith('matlab:')) {
                        sendCommandToMATLAB(command.replace('matlab:', ''));
                    }
                });
            });
        }
        terminal.scrollTop = terminal.scrollHeight;
    }
</script>
</body>
</html>