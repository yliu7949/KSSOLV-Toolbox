<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Window UI</title>

    <script src="./3p/markdown-it/markdown-it.min.js"></script>
    <script defer src="./3p/katex/katex.min.js"
            integrity="sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./3p/katex/katex.min.css"
          integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">
    <script src="./3p/highlight.js/highlight.min.js"></script>
    <link rel="stylesheet" href="./3p/highlight.js/default.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: Arial, sans-serif;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 防止body出现滚动条 */
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 5px;
        }

        #container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        #terminal {
            flex: 1;
            overflow-y: auto;
            padding: 5px 5px 55px 5px; /* 给input-container留出空间 */
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }

        /* 调整列表间距和高度 */
        #terminal ul, #terminal ol {
            line-height: 1;
            padding-left: 1.5em;
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: 0.1em;
        }

        #terminal li {
            height: fit-content;
            margin: 0;
            line-height: 1;
        }

        #input-container {
            display: flex;
            align-items: center;
            border-top: 1px solid #ccc;
            padding: 10px 5px 5px;
            background: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        #input-container span {
            margin-right: 7px;
            font-family: monospace;
            font-size: 15px;
        }

        #command-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 5px;
            font-size: 15px;
            font-family: monospace;
            height: 30px;
        }

        #suggestions-container {
            position: absolute;
            bottom: 100%;
            left: 30px;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            margin-bottom: 10px;
            scrollbar-width: thin;
        }

        #suggestions-container::-webkit-scrollbar {
            width: 8px;
        }

        #suggestions-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #suggestions-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #suggestions-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .suggestion-item {
            padding: 8px 10px;
            cursor: pointer;
            font-family: monospace;
            font-size: 13px;
            height: 30px;
            line-height: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .suggestion-item.selected {
            background-color: #e0e0e0;
        }

        .katex {
            font-size: 13px; /* 让公式的字号变得小一些 */
        }
    </style>
</head>
<body>
<div id="container">
    <div id="terminal"></div>
    <div id="input-container">
        <span>&gt;&gt;</span>
        <label for="command-input"></label>
        <input autofocus id="command-input" type="text">
        <div id="suggestions-container"></div>
    </div>
</div>
<script>
    // 基础变量声明
    let MATLAB;                          // MATLAB组件引用
    let history = [];                    // 命令历史记录
    let historyIndex = -1;               // 历史记录当前索引
    let selectedSuggestionIndex = -1;    // 当前选中的建议项索引
    let references = ['clc', 'whos', 'help', 'dev', 'clear', 'ANS']; // 基础命令列表

    const terminal = document.getElementById("terminal");
    const input = document.getElementById("command-input");
    const suggestionsContainer = document.getElementById("suggestions-container");

    // 查找数组中所有字符串的最长公共前缀
    function findLongestCommonPrefix(strings, currentInput) {
        if (strings.length === 0) return '';

        // 获取当前输入后的相关部分
        const relevantParts = strings.map(str => str.slice(currentInput.length));

        // 从第一个字符串开始作为潜在前缀
        let prefix = relevantParts[0];

        // 与其他字符串比较
        for (let i = 1; i < relevantParts.length; i++) {
            // 当前前缀与当前字符串不匹配时
            while (relevantParts[i].indexOf(prefix) !== 0) {
                // 缩短前缀
                prefix = prefix.substring(0, prefix.length - 1);
                if (prefix === '') return '';
            }
        }

        return prefix;
    }

    // 获取待补全的文本
    function getLastWord(value, cursorPosition) {
        const textBeforeCursor = value.substring(0, cursorPosition);
        const match = textBeforeCursor.match(/([a-zA-Z]+\.)*[a-zA-Z.]*$/);
        return match ? match[0] : '';
    }

    // 获取匹配的建议列表
    function getSuggestions(input) {
        if (!input) return [];
        return references.filter(ref =>
            ref.toLowerCase().startsWith(input.toLowerCase())
        );
    }

    // 插入补全文本
    function insertCompletion(originalText, cursorPosition, completion, lastWord) {
        const beforeCursor = originalText.substring(0, cursorPosition - lastWord.length);
        const afterCursor = originalText.substring(cursorPosition);
        return beforeCursor + completion + afterCursor;
    }

    // 应用选中的建议
    function applySelectedSuggestion() {
        const suggestionItems = suggestionsContainer.querySelectorAll('.suggestion-item');
        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
            const suggestion = suggestionItems[selectedSuggestionIndex].textContent;
            const cursorPosition = input.selectionStart;
            const lastWord = getLastWord(input.value, cursorPosition);
            input.value = insertCompletion(input.value, cursorPosition, suggestion, lastWord);
            suggestionsContainer.style.display = 'none';
            input.focus();
            const newPosition = cursorPosition - lastWord.length + suggestion.length;
            input.setSelectionRange(newPosition, newPosition);
            selectedSuggestionIndex = -1;
        }
    }

    // 更新选中的建议项
    function updateSelectedSuggestion() {
        const items = suggestionsContainer.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            if (index === selectedSuggestionIndex) {
                item.classList.add('selected');
                // 确保选中项可见
                const containerHeight = suggestionsContainer.clientHeight;
                const itemHeight = item.offsetHeight;
                const itemTop = item.offsetTop;
                const scrollTop = suggestionsContainer.scrollTop;

                if (itemTop < scrollTop) {
                    suggestionsContainer.scrollTop = itemTop;
                } else if (itemTop + itemHeight > scrollTop + containerHeight) {
                    suggestionsContainer.scrollTop = itemTop + itemHeight - containerHeight;
                }
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // 显示建议列表
    function showSuggestions(suggestions) {
        suggestionsContainer.innerHTML = '';
        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = suggestion;
            div.onclick = () => {
                const cursorPosition = input.selectionStart;
                const lastWord = getLastWord(input.value, cursorPosition);
                input.value = insertCompletion(input.value, cursorPosition, suggestion, lastWord);
                suggestionsContainer.style.display = 'none';
                input.focus();
                const newPosition = cursorPosition - lastWord.length + suggestion.length;
                input.setSelectionRange(newPosition, newPosition);
                selectedSuggestionIndex = -1;
            };
            suggestionsContainer.appendChild(div);
        });
        suggestionsContainer.style.display = suggestions.length ? 'block' : 'none';
        selectedSuggestionIndex = -1;
    }

    // 处理滚轮事件
    suggestionsContainer.addEventListener('wheel', function (e) {
        e.preventDefault();
        suggestionsContainer.scrollTop += e.deltaY;
    });

    // 处理键盘事件
    input.addEventListener("keydown", function (event) {
        const isSuggestionsVisible = suggestionsContainer.style.display === 'block';

        if (event.key === "Tab") {
            event.preventDefault();

            if (isSuggestionsVisible) {
                if (selectedSuggestionIndex >= 0) {
                    applySelectedSuggestion();
                } else {
                    const cursorPosition = input.selectionStart;
                    const lastWord = getLastWord(input.value, cursorPosition);
                    const matches = getSuggestions(lastWord);

                    if (matches.length > 1) {
                        // 找到最长公共前缀并应用
                        const commonPrefix = findLongestCommonPrefix(matches, lastWord);
                        if (commonPrefix) {
                            const newValue = lastWord + commonPrefix;
                            input.value = insertCompletion(input.value, cursorPosition, newValue, lastWord);
                            const newPosition = cursorPosition - lastWord.length + newValue.length;
                            input.setSelectionRange(newPosition, newPosition);

                            // 更新建议列表
                            const newMatches = getSuggestions(newValue);
                            showSuggestions(newMatches);
                        }
                    } else if (matches.length === 1) {
                        input.value = insertCompletion(input.value, cursorPosition, matches[0], lastWord);
                        suggestionsContainer.style.display = 'none';
                        const newPosition = cursorPosition - lastWord.length + matches[0].length;
                        input.setSelectionRange(newPosition, newPosition);
                    }
                }
            } else {
                const cursorPosition = input.selectionStart;
                const lastWord = getLastWord(input.value, cursorPosition);
                const matches = getSuggestions(lastWord);

                if (matches.length === 1) {
                    input.value = insertCompletion(input.value, cursorPosition, matches[0], lastWord);
                    const newPosition = cursorPosition - lastWord.length + matches[0].length;
                    input.setSelectionRange(newPosition, newPosition);
                } else if (matches.length > 1) {
                    showSuggestions(matches);
                }
            }
        } else if (event.key === "Enter") {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
            let command = input.value.trim();

            if (command) {
                // 检查是否是特殊命令格式
                const singleDollarMatch = command.match(/^\$\s*(.*)/);
                const doubleDollarMatch = command.match(/^\$\$\s*(.*)/);

                if (singleDollarMatch || doubleDollarMatch) {
                    const actualCommand = singleDollarMatch ?
                        singleDollarMatch[1] : doubleDollarMatch[1];
                    const useHistory = !doubleDollarMatch;

                    if (actualCommand) {
                        history.push(command);
                        historyIndex = history.length;
                        if (terminal.innerHTML.length > 0 && !terminal.innerHTML.endsWith('\n')) {
                            terminal.innerHTML += `\n`;
                        }
                        terminal.innerHTML += `>> ${command}\n`;
                        currentResponseContent = '';
                        responseContainer = null;
                        sendUserPromptToMATLAB(actualCommand, useHistory);
                        input.value = "";
                        return;
                    }
                }

                history.push(command);
                historyIndex = history.length;

                if (/\bclear\b/i.test(command)) {
                    input.value = "";
                    if (terminal.innerHTML.length > 0 && !terminal.innerHTML.endsWith('\n')) {
                        terminal.innerHTML += `\n`;
                    }
                    terminal.innerHTML += `>> ${command}\n`;
                    currentResponseContent = '';
                    responseContainer = null;
                    return;
                } else if (/\bclc\b/i.test(command)) {
                    terminal.innerHTML = "";
                    input.value = "";
                    currentResponseContent = '';
                    responseContainer = null;
                    return;
                }

                if (terminal.innerHTML.length > 0 && !terminal.innerHTML.endsWith('\n')) {
                    terminal.innerHTML += `\n`;
                }
                terminal.innerHTML += `>> ${command}\n`;
                currentResponseContent = '';
                responseContainer = null;

                if (command === "dev") {
                    command = "kssolv.ui.debug.WebWindow.openDevTools()";
                }
                sendCommandToMATLAB(command);
            }
            input.value = "";
        } else if (event.key === "Escape") {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
        } else if (event.key === "ArrowUp") {
            if (isSuggestionsVisible) {
                event.preventDefault();
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                if (selectedSuggestionIndex > 0) {
                    selectedSuggestionIndex--;
                } else {
                    selectedSuggestionIndex = items.length - 1;
                }
                updateSelectedSuggestion();
            } else if (historyIndex > 0) {
                historyIndex--;
                input.value = history[historyIndex];
            }
            event.preventDefault();
        } else if (event.key === "ArrowDown") {
            if (isSuggestionsVisible) {
                event.preventDefault();
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                if (selectedSuggestionIndex < items.length - 1) {
                    selectedSuggestionIndex++;
                } else {
                    selectedSuggestionIndex = 0;
                }
                updateSelectedSuggestion();
            } else {
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    input.value = history[historyIndex];
                } else {
                    historyIndex = history.length;
                    input.value = "";
                }
            }
            event.preventDefault();
        }
    });

    // 输入时更新建议列表
    input.addEventListener("input", function () {
        // 恢复自动滚动至底部
        autoScrolledUp = true;

        // 如果输入以 $ 或 $$ 开头，不自动显示建议
        if (input.value.startsWith('$')) {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
            return;
        }

        const cursorPosition = input.selectionStart;
        const lastWord = getLastWord(input.value, cursorPosition);
        const matches = getSuggestions(lastWord);
        showSuggestions(matches);
    });

    // 点击其他区域时隐藏建议列表
    document.addEventListener('click', function (e) {
        if (!suggestionsContainer.contains(e.target) && e.target !== input) {
            suggestionsContainer.style.display = 'none';
            selectedSuggestionIndex = -1;
        }
    });

    let autoScrolledUp = true;
    // 监听输出区域的滚动事件
    terminal.addEventListener('wheel', (event) => {
        if (event.deltaY < 0) {
            // 用户向上滚动
            autoScrolledUp = false;
        } else if (event.deltaY > 0) {
            // 用户向下滚动，检查是否到达底部
            if (terminal.scrollTop + terminal.clientHeight >= terminal.scrollHeight) {
                autoScrolledUp = true;
            }
        }
    });

    // 发送命令到 MATLAB
    function sendCommandToMATLAB(command) {
        if (typeof MATLAB !== 'undefined') {
            MATLAB.sendEventToMATLAB("CommandSubmitted", command);
        } else {
            terminal.innerHTML += "!! MATLAB 不可用\n\n";
        }
    }

    // 发送用户提示词到 MATLAB
    function sendUserPromptToMATLAB(prompt, useHistory) {
        if (typeof MATLAB !== 'undefined') {
            MATLAB.sendEventToMATLAB("UserPromptSubmitted", {
                prompt: prompt,
                useHistory: useHistory
            });
        } else {
            terminal.innerHTML += "!! MATLAB 不可用\n\n";
        }
    }

    // 设置 MATLAB 组件
    function setup(htmlComponent) {
        MATLAB = htmlComponent;
        htmlComponent.addEventListener("ResultUpdated", resultFromMATLABToHTML);
        htmlComponent.addEventListener("DataChanged", () => {
            references = MATLAB.Data.join(',');
            references = references.split(',');
            references = ['ANS', 'dev'].concat(references);
        });
        htmlComponent.addEventListener("TokensStreamed", tokensStreamedFromMATLABToHTML);
    }

    // 处理 MATLAB 返回结果
    function resultFromMATLABToHTML(event) {
        if (event.Data) {
            terminal.innerHTML += event.Data + "\n";

            document.querySelectorAll('#terminal a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    let command = this.getAttribute('href');
                    if (command.startsWith('matlab:')) {
                        sendCommandToMATLAB(command.replace('matlab:', ''));
                    }
                });
            });
        }
        if (autoScrolledUp) {
            terminal.scrollTop = terminal.scrollHeight;
        }
    }

    // 当前是否在处理思考内容
    let isProcessingThink = false;
    let currentThinkContent = '';
    let thinkContainer = null;
    let currentResponseContent = '';
    let responseContainer = null;
    const md = window.markdownit({
        breaks: false,
        typographer: true,
        highlight: function (str, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return '<pre><code class="hljs">' +
                        hljs.highlight(str, {language: lang, ignoreIllegals: true}).value +
                        '</code></pre>';
                } catch (__) {
                }
            }

            return '<pre><code class="hljs">' + md.utils.escapeHtml(str) + '</code></pre>';
        }
    });

    // 处理 MATLAB 返回 tokens
    function tokensStreamedFromMATLABToHTML(event) {

        if (!event.Data) return;

        const terminal = document.getElementById("terminal");
        let content = event.Data;

        // 检测 think 标签的开始
        if (content.includes('<think>')) {
            isProcessingThink = true;
            return
        }

        // 检测思考标签的结束
        if (content.includes('</think>')) {
            isProcessingThink = false;
            currentThinkContent = '';
            if (thinkContainer) {
                thinkContainer.scrollTop = thinkContainer.scrollHeight;
            }
            thinkContainer = null;
            return
        }

        // 如果正在处理思考内容
        if (isProcessingThink) {
            if (currentThinkContent === '') {
                // 若此前并没有保留下来的思考内容

                if (/^\n+$/.test(content)) {
                    // 若 content 仅包含换行符号则直接返回
                    return;
                } else {
                    // 若当前 tokens 为非空白字符，则是思考内容的第一个 tokens
                    if (thinkContainer == null) {
                        thinkContainer = document.createElement('div');
                        thinkContainer.style.cssText = `
                            color: #888;
                            background-color: #f5f5f5;
                            padding: 8px;
                            margin: 4px 0;
                            border-radius: 4px;
                            max-height: 80px;
                            overflow-y: auto;
                            white-space: pre-wrap;
                            font-size: 0.9em;
                        `;
                        terminal.appendChild(thinkContainer);
                    }
                    currentThinkContent += content;
                    thinkContainer.innerHTML = currentThinkContent;
                    thinkContainer.scrollTop = thinkContainer.scrollHeight;
                    if (autoScrolledUp) {
                        terminal.scrollTop = terminal.scrollHeight;
                    }
                }
            } else {
                // 若已输出思考内容
                currentThinkContent += content;
                thinkContainer.innerHTML = currentThinkContent;
                thinkContainer.scrollTop = thinkContainer.scrollHeight;
                if (autoScrolledUp) {
                    terminal.scrollTop = terminal.scrollHeight;
                }
            }
            return
        }

        // 如果正在处理非思考内容
        if (responseContainer == null) {
            responseContainer = document.createElement('div');
            responseContainer.style.cssText = `
                width: 100%;
                height: fit-content;
                border: transparent;
                background: white;
                font-family: monospace;
                font-size: 13px;
                white-space: pre-wrap;
            `;
            terminal.appendChild(responseContainer);
        }

        if (/^\n{2,}$/.test(content)) {
            content = '\n';
        }

        currentResponseContent += content;

        let processedContent = currentResponseContent;
        // 分别替换行内公式 (\(...\)) 和行间公式 (\[...\]) 为 $...$ 和 $$...$$
        processedContent = processedContent.replace(/\\\((.*?)\\\)/g, (match, formula) => {
            return `$${formula}$`;
        });
        processedContent = processedContent.replace(/\\\[([\s\S]*?)\\\]/g, (match, formula) => {
            return `$$${formula}$$`;
        });
        // 使用 markdown-it 渲染处理后的内容
        responseContainer.innerHTML = md.render(processedContent);

        // 获取所有非 <pre> 和 <code> 元素，使用 katex 进行公式渲染
        const elements = responseContainer.querySelectorAll(':not(pre):not(code)');
        elements.forEach((element) => {
            // 渲染行间公式 $$ ... $$ 为独立的块级元素
            let text = element.innerHTML.replace(/\$\$(.*?)\$\$/gs, (match, formula) => {
                // 使用 KaTeX 渲染公式，并包裹在 <div> 中
                return `<div class="katex">${katex.renderToString(formula)}</div>`;
            });

            // 渲染行内公式 $ ... $ 为行内元素
            text = text.replace(/\$([^$]+)\$/g, (match, formula) => {
                // 使用 KaTeX 渲染公式，并包裹在 <span> 中
                return `<span class="katex">${katex.renderToString(formula)}</span>`;
            });

            element.innerHTML = text;
        });

        // 高亮代码块中的代码
        hljs.highlightAll();

        if (autoScrolledUp) {
            terminal.scrollTop = terminal.scrollHeight;
        }
    }
</script>
</body>
</html>